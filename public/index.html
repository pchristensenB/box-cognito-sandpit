<!DOCTYPE html>
<html lang="en-US">

<head>
	<meta charset="utf-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<meta name="viewport" content="width=device-width, initial-scale=1">

	<!-- JQuery -->
	<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>

	<script src="/dist/amazon-cognito-auth.js"></script>
	<!-- To enable the advanced security feature -->
	<!-- <script src="https://amazon-cognito-assets.<region>.amazoncognito.com/amazon-cognito-advanced-security-data.min.js"></script> -->
	<!-- E.g. -->
	<!-- <script src="https://amazon-cognito-assets.us-east-1.amazoncognito.com/amazon-cognito-advanced-security-data.min.js"></script> -->
	<title>Box Platform + Cognito</title>

	<!-- CSS -->

	<!-- Font Awesome -->
	<link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.8.2/css/all.css">
	<!-- Bootstrap core CSS -->
	<link href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.3.1/css/bootstrap.min.css" rel="stylesheet">
	<!-- Material Design Bootstrap -->

	<link rel="stylesheet" href="https://cdn01.boxcdn.net/platform/elements/11.0.0/en-US/explorer.css" />
	<style>
		#app-container,
		#signoutDiv,
		#loadingDiv {
			display: none;
		}
	</style>
	<style>
		/* Style the button that is used to open and close the collapsible content */

		.collapsible {
			background-color: #eee;
			color: #444;
			cursor: pointer;
			float: right;
			margin-right: 20px;
			border: none;
			text-align: left;
			outline: none;
			font-size: 12px;
		}

		/* Add a background color to the button if it is clicked on (add the .active class with JS), and when you move the mouse over it (hover) */

		.collapsible:hover {
			background-color: #ccc;
		}

		/* Style the collapsible content. Note: hidden by default */

		.content {
			float: right;
			margin-right: 20px;
			color: #ccb7ca;
			font-size: 10pt;
			padding: 0 18px;
			display: none;
		}
		.waves-light {
			color: white !important;
		}
	</style>

	<!-- Bootstrap tooltips -->
	<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.4/umd/popper.min.js"></script>
	<!-- Bootstrap core JavaScript -->
	<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.3.1/js/bootstrap.min.js"></script>
	<!-- MDB core JavaScript -->
	<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mdbootstrap/4.8.11/js/mdb.min.js"></script>
	<!-- BOX JS-->

	<script src="https://cdn.polyfill.io/v2/polyfill.min.js?features=es6,Intl"></script>

	<script src="https://cdn01.boxcdn.net/platform/elements/11.0.0/en-US/explorer.js"></script>

</head>

<body onload="onLoad()">
	<div class="navbar-wrapper">
		<div class="container">

				<nav class="navbar navbar-expand-lg navbar-light bg-primary">
						<div class="container">

					<div id="navbar" class="navbar-collapse collapse">
						<ul class="navbar-nav mr-auto">
							<li class="nav-item active">
								<a class="nav-link waves-effect waves-light" href="#">Home</a>
							</li>
							<li class="nav-item" id="loginLink">
								<a class="nav-link waves-effect waves-light" id="signInButton" href="javascript:void(0)" title="Sign in">Log in/Register</a>

						</ul>
					</div>
				</div>
			</nav>
			<button type="button" class="collapsible" id="userinfo">Open User Info</button>
			<div id="user" class="content"></div>

		</div>
	</div>

	<div style="margin:auto;width:50%;">
		<div id="boxUI">
			<div id="app-container" style="width:80%;"></div>
		</div>
		<section class="view">
			<div class="row">
				<div class="col-md-6">
					<div class="d-flex flex-column  h-100">
						<h3 class="heading display-5">Cognito and Box Platform Demo</h3>
						<p class="subheading" id="mainMsg1">Shows Cognito integration with Box platform and app users. In this demo we use
							<a href="https://github.com/aws/amazon-cognito-auth-js" target="_new">Cognito's Javascript API</a> and we redirect to Cognito built-in login and registration forms. The Box App User is
							created in a lambda when the user is verified and the 'external_app_user_id' attribute is populated with the Cognito
							userID.
						</p>
						<h4 class="subheading" id="mainMsg"></h4>
						<div>
							<p id="statusNotAuth" title="Status">
								Login or register to continue
							</p>
							<p id="statusAuth" title="Status">
								You have Signed-In
							</p>
						</div>
					</div>

				</div>

				<div class="col-md-6">
					<a href="#" id="popreg">
						[ Register Diagram |
					</a>
					<a href="#" id="poplog">
						Login Diagram ]
					</a>
					<div class="view">
						<img src="https://pchristensenb.github.io/Template/sidebar-image.jpeg" class="img-fluid" alt="smaple image">
						<div class="mask flex-center gradient">
						</div>
					</div>

				</div>

			</div>

		</section>
	</div>
	<div class="modal fade" id="imagemodal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
		<div class="modal-dialog">
			<div class="modal-content">
				<div class="modal-header">
					<button type="button" class="close" data-dismiss="modal">
						<span aria-hidden="true">&times;</span>
						<span class="sr-only">Close</span>
					</button>
				</div>
				<div class="modal-body" style="background:white;">
					<img src="" style="margin-left:-400px;margin-top:-100px;" id="imagepreview">
				</div>

			</div>
		</div>
	</div>
	<script>
		function showBoxUI(boxAccessToken) {
			console.log("tok:" + boxAccessToken)
			$(".view").hide();
			var folderId = '0';
			var contentExplorer = new Box.ContentExplorer();
			contentExplorer.show(folderId, boxAccessToken, {
				container: '#app-container',
				logoUrl: 'box'
			})
			
			$("#app-container").height(600);
			var coll = document.getElementsByClassName("collapsible");
			var i;

			for (i = 0; i < coll.length; i++) {
				coll[i].addEventListener("click", function () {
					this.classList.toggle("active");
					var content = this.nextElementSibling;
					if (content.style.display === "block") {
						content.style.display = "none";
						$("#userinfo").text("Show user info");
					} else {
						content.style.display = "block";
						$("#userinfo").text("Hide user info");
					}
				});
			}
			$("#app-container").show();
			$("#myModal").toggle();
		}
		// Operations when the web page is loaded.
		function onLoad() {
			$("#imagemodal").toggle();

			$("#popreg").on("click", function () {
				$('#imagepreview').attr('src', '/img/register.png');
				$('#imagemodal').modal('show'); // imagemodal is the id attribute assigned to the bootstrap modal, then i use the show function
			});
			$("#poplog").on("click", function () {
				$('#imagepreview').attr('src', '/img/login.png');
				$('#imagemodal').modal('show'); // imagemodal is the id attribute assigned to the bootstrap modal, then i use the show function
			});
			var i, items, tabs;
			items = document.getElementsByClassName("tab-pane");
			for (i = 0; i < items.length; i++) {
				items[i].style.display = 'none';
			}
			document.getElementById("statusNotAuth").style.display = 'block';
			document.getElementById("statusAuth").style.display = 'none';
			// Initiatlize CognitoAuth object
			var auth = initCognitoSDK();
			document.getElementById("signInButton").addEventListener("click", function () {
				var state = document.getElementById('signInButton').innerHTML;
				console.log(state == 'Log in/Register');
				if (state.contains('Log in/Register')) {
					userButton(auth);
				}
				else {
					auth.signOut();
					//showSignedOut();
				}
			});
			var curUrl = window.location.href;
			auth.parseCognitoWebResponse(curUrl);

		}



		// Perform user operations.
		function userButton(auth) {
			var state = document.getElementById('signInButton').innerHTML;
			if (state === "Sign Out") {
				document.getElementById("signInButton").innerHTML = "Sign In";
				auth.signOut();
				showSignedOut();
			} else {
				//auth.getSession();
				window.location.href='https://boxsandpitdemoapp.auth.eu-west-2.amazoncognito.com/login?client_id=l8ajfjlh0lsrspnknvnqnunpq&response_type=token&scope=email+openid&redirect_uri=https://box-cognito-sandpit.herokuapp.com';
			}
		}

		// Operations when signed in.
		function showSignedIn(session) {
			document.getElementById("statusNotAuth").style.display = 'none';
			document.getElementById("statusAuth").style.display = 'block';
			document.getElementById("signInButton").innerHTML = "Sign Out";
			if (session) {
				console.log(session);
				
			}
			//openTab("userdetails");
		}

		// Operations when signed out.
		function showSignedOut() {
			document.getElementById("statusNotAuth").style.display = 'block';
			document.getElementById("statusAuth").style.display = 'none';
			document.getElementById('idtoken').innerHTML = " ... ";
			document.getElementById('acctoken').innerHTML = " ... ";
			document.getElementById('reftoken').innerHTML = " ... ";
			closeTab("userdetails");
		}

		// Initialize a cognito auth object.
		function initCognitoSDK() {
			var authData = {
				ClientId: 'l8ajfjlh0lsrspnknvnqnunpq', // Your client id here
				AppWebDomain: 'boxsandpitdemoapp.auth.eu-west-2.amazoncognito.com', // Exclude the "https://" part. 
				TokenScopesArray: ['email','openid'], // like ['openid','email','phone']...
				RedirectUriSignIn: location.protocol + '//' + location.hostname + (location.port ? ':' + location.port : ''),
				RedirectUriSignOut: location.protocol + '//' + location.hostname + (location.port ? ':' + location.port : ''),
				IdentityProvider: 'box-cognito-sandpit',
				UserPoolId: 'eu-west-2_T8FRIx8R8',
				AdvancedSecurityDataCollectionFlag: false
			};
			var auth = new AmazonCognitoIdentity.CognitoAuth(authData);
			// You can also set state parameter 
			// auth.setState(<state parameter>);  
			auth.userhandler = {
				onSuccess: function (result) {
					console.log("res:" + JSON.stringify(result));
					showSignedIn(result);
					getBoxToken(result);
				},
				onFailure: function (err) {
					alert("Error!" + err);
				}
			};
			return auth;
		}
		function getBoxToken(cognitoAccess) {
			console.log(cognitoAccess);
			$.post("/boxUI", { accessToken: cognitoAccess.accessToken.jwtToken,idToken:cognitoAccess.idToken.jwtToken }, function (json) {
				console.log("msg: " + JSON.stringify(json));
				boxAccessToken = json.accessToken;
				showBoxUI(boxAccessToken);
				$("#user").append("Cognito User:" + json.userName).append("<br/>");
				$("#user").append("Cognito Email:" + json.email).append("<br/>");
				$("#user").append("Cognito ID:" + json.cognitoId).append("<br/>");
				$("#user").append("Box User ID:" + json.boxId).append("<br/>");
				$("#user").append("Box external app user ID:" + json.extId).append("<br/>");
				$("#user").append("Box User Name:" + json.userName).append("<br/>");
				$("#user").append("Box User Login:" + json.login).append("<br/>");

			})
		}

	</script>
</body>

</html>