<!--
 Amazon Cognito Auth SDK for JavaScript
 Copyright 2017 Amazon.com, Inc. or its affiliates. All Rights Reserved.

 Licensed under the Apache License, Version 2.0 (the "License").
 You may not use this file except in compliance with the License.
 A copy of the License is located at

         http://aws.amazon.com/apache2.0/

 or in the "license" file accompanying this file.
 This file is distributed on an "AS IS" BASIS, WITHOUT WARRANTIES
 OR CONDITIONS OF ANY KIND, either express or implied. See the
 License for the specific language governing permissions
 and limitations under the License.
-->

<!DOCTYPE html>
<html lang="en-US">
<head>
	<meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
	
<!-- JQuery -->
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>

<script src="/dist/amazon-cognito-auth.min.js"></script>
	<!-- To enable the advanced security feature -->
	<!-- <script src="https://amazon-cognito-assets.<region>.amazoncognito.com/amazon-cognito-advanced-security-data.min.js"></script> -->
	<!-- E.g. -->
	<!-- <script src="https://amazon-cognito-assets.us-east-1.amazoncognito.com/amazon-cognito-advanced-security-data.min.js"></script> -->
	<title>Box Platform + Cognito</title>

	<!-- CSS -->

	<!-- Font Awesome -->
<link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.8.2/css/all.css">
<!-- Bootstrap core CSS -->
<link href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.3.1/css/bootstrap.min.css" rel="stylesheet">
<!-- Material Design Bootstrap -->
<link href="https://cdnjs.cloudflare.com/ajax/libs/mdbootstrap/4.8.11/css/mdb.min.css" rel="stylesheet">

	<link rel="stylesheet" href="https://cdn01.boxcdn.net/platform/elements/10.1.0/en-US/explorer.css" />

	<link href="https://ok1static.oktacdn.com/assets/js/sdk/okta-signin-widget/2.6.0/css/okta-sign-in.min.css" type="text/css" rel="stylesheet">

	<style>

	#app-container, #signoutDiv, #loadingDiv
	{
		display: none;
	}
	</style>

<!-- ********** JAVASCRIPT ***************** -->

<!-- OKTA AUTHN WIDGET -->

<!-- Bootstrap tooltips -->
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.4/umd/popper.min.js"></script>
<!-- Bootstrap core JavaScript -->
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.3.1/js/bootstrap.min.js"></script>
<!-- MDB core JavaScript -->
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mdbootstrap/4.8.11/js/mdb.min.js"></script>
<!-- BOX JS-->

<script src="https://cdn.polyfill.io/v2/polyfill.min.js?features=es6,Intl"></script>

<script src="https://cdn01.boxcdn.net/platform/elements/10.1.0/en-US/explorer.js"></script>

</head>

<body  onload="onLoad()">
	<div class="navbar-wrapper">
		<div class="container">
  
				  <nav class="navbar navbar-expand-lg sticky-top navbar-dark  blue-gradient">
			<div class="container">
			  
			  <div id="navbar" class="navbar-collapse collapse">
					<ul class="navbar-nav mr-auto">
								  <li class="nav-item active"><a class="nav-link waves-effect waves-light" href="#">Home</a></li>
				  <li class="nav-item" id = "loginLink">
						<a class="nav-link waves-effect waves-light" id="signInButton" href="javascript:void(0)" title="Sign in">Log in/Register</a>
				  <li class="nav-item" id = "signoutLink"><a class="nav-link waves-effect waves-light" href="#" onclick="javascript:void(0)" id="signout">Sign out</a></li>
  
				</ul>
			  </div>
			</div>
		  </nav>
		</div>
	  </div>
  
	  <div style="margin-top:50px;margin-left:50px;">
		  <div id = "boxUI">
				  <div id = "app-container" style="width:80%;"></div>
			  </div>
		  <section class="view">
			  <div class="row">
				  <div class="col-md-6">
					  <div class="d-flex flex-column justify-content-center align-items-center h-100">
						  <h3 class="heading display-4">Welcome to the Cognito and Box Platform Demo</h3>
						  <h4 class="subheading" id="mainMsg1">Shows Cognito integration with Box platform and app users</h4>
						  <h4 class="subheading" id="mainMsg"></h4>
						  <div>
								<p id="statusNotAuth" title="Status">
									Login or register to continue
								</p>
								<p id="statusAuth" title="Status">
									You have Signed-In
								</p>
							</div>
					  </div>
  
				  </div>
  
				  <div class="col-md-6">
  
					  <div class="view">
						  <img src="https://pchristensenb.github.io/Template/sidebar-image.jpeg" class="img-fluid" alt="smaple image">
						  <div class="mask flex-center gradient">
						  </div>
					  </div>
  
				  </div>
  
			  </div>
  
		  </section>
		</div>
 
	<script>
function showBoxUI(boxAccessToken) {
	
	$("#view").hide();
	getBoxToken(boxAccessToken).then(function(result) {
		var folderId = '0';

		var contentExplorer = new Box.ContentExplorer();
		contentExplorer.show(folderId, accessToken, {
			container: '#app-container',
			logoUrl: 'box'
			// logoUrl: 'https://www.okta.com/sites/all/themes/Okta/images/blog/Logos/Okta_Logo_BrightBlue_Medium.png'
		})
	});

	$("#app-container").show();
	$("#myModal").toggle();
}
var accessToken;
	// Operations when the web page is loaded.
	function onLoad() {
		var i, items, tabs;
		items = document.getElementsByClassName("tab-pane");
		for (i = 0; i < items.length; i++) {
			items[i].style.display = 'none';
		}
		document.getElementById("statusNotAuth").style.display = 'block';
		document.getElementById("statusAuth").style.display = 'none';
		// Initiatlize CognitoAuth object
		var auth = initCognitoSDK();
		document.getElementById("signInButton").addEventListener("click", function() {
			userButton(auth);
		});
		document.getElementById("signout").addEventListener("click", function() {
			auth.signOut();
			showSignedOut();
		});
		var curUrl = window.location.href;
		auth.parseCognitoWebResponse(curUrl);

	}

  // Operation when tab is closed.
	function closeTab(tabName) {
	  document.getElementById(tabName).style.display = 'none';
	}

  // Operation when tab is opened.
  function openTab(tabName) {
		document.getElementById(tabName).style.display = 'block';
	}

  // Operations about toggle tab.
	function toggleTab(tabName) {
		if (document.getElementById("usertab").style.display == 'none') {
			document.getElementById("usertab").style.display = 'block';
			document.getElementById("tabIcon").innerHTML = '_';
		} else {
			document.getElementById("usertab").style.display = 'none';
			document.getElementById("tabIcon").innerHTML = '+';
		}
	}

  // Operations when showing message.
	function showMessage(msgTitle, msgText, msgDetail) {
		var msgTab = document.getElementById('message');
		document.getElementById('messageTitle').innerHTML = msgTitle;
		document.getElementById('messageText').innerHTML = msgText;
		document.getElementById('messageDetail').innerHTML = msgDetail;
		msgTab.style.display = "block";
	}

  // Perform user operations.
	function userButton(auth) {
		var state = document.getElementById('signInButton').innerHTML;
		if (state === "Sign Out") {
			document.getElementById("signInButton").innerHTML = "Sign In";
			auth.signOut();
			showSignedOut();
		} else {
			auth.getSession();
		}
	}

	// Operations when signed in.
  function showSignedIn(session) {
		document.getElementById("statusNotAuth").style.display = 'none';
		document.getElementById("statusAuth").style.display = 'block';
		document.getElementById("signInButton").innerHTML = "Sign Out";
		if (session) {
			var idToken = session.getIdToken().getJwtToken();
			if (idToken) {
				var payload = idToken.split('.')[1];
				var tokenobj = JSON.parse(atob(payload));
				var formatted = JSON.stringify(tokenobj, undefined, 2);
				document.getElementById('idtoken').innerHTML = formatted;
			}
			var accToken = session.getAccessToken().getJwtToken();
			if (accToken) {
				var payload = accToken.split('.')[1];
				var tokenobj = JSON.parse(atob(payload));
				var formatted = JSON.stringify(tokenobj, undefined, 2);
				//document.getElementById('acctoken').innerHTML = formatted;
			}
			var refToken = session.getRefreshToken().getToken();
			if (refToken) {
				document.getElementById('reftoken').innerHTML = refToken.substring(1, 20);
			}
		}
		//openTab("userdetails");
	}

	// Operations when signed out.
	function showSignedOut() {
		document.getElementById("statusNotAuth").style.display = 'block';
		document.getElementById("statusAuth").style.display = 'none';
		document.getElementById('idtoken').innerHTML = " ... ";
		document.getElementById('acctoken').innerHTML = " ... ";
		document.getElementById('reftoken').innerHTML = " ... ";
		closeTab("userdetails");
	}

  // Initialize a cognito auth object.
	function initCognitoSDK() {
		var authData = {
			ClientId : 'l8ajfjlh0lsrspnknvnqnunpq', // Your client id here
			AppWebDomain : 'boxsandpitdemoapp.auth.eu-west-2.amazoncognito.com', // Exclude the "https://" part. 
			TokenScopesArray : ['email'], // like ['openid','email','phone']...
			RedirectUriSignIn : 'http://localhost:3000',
			RedirectUriSignOut : 'http://localhost:3000',
			IdentityProvider : 'box-cognito-sandpit', 
	                UserPoolId : 'eu-west-2_T8FRIx8R8', 
	                AdvancedSecurityDataCollectionFlag : false
		};
		var auth = new AmazonCognitoIdentity.CognitoAuth(authData);
		// You can also set state parameter 
		// auth.setState(<state parameter>);  
		auth.userhandler = {
			onSuccess: function(result) {
				alert("Sign in success");
				console.log("res:" + JSON.stringify(result));
				showSignedIn(result);
				console.log(result.accessToken);
				showBoxUI(result.accessToken);
			},
			onFailure: function(err) {
				alert("Error!" + err);
			}
		};
		// The default response_type is "token", uncomment the next line will make it be "code".
		// auth.useCodeGrantFlow();
		return auth;
	}
	async function getBoxToken(cognitoAccess) {
		console.log(JSON.stringify(cognitoAccess));
		// https://na43ohqfe2.execute-api.eu-west-2.amazonaws.com/default/box-cognito-sandpit-token-exchange
		await $.ajax({
			url: 'https://4anvob1li7.execute-api.eu-west-2.amazonaws.com/default/box-cognito-sandpit-token-exchange',
			//url:"https://na43ohqfe2.execute-api.eu-west-2.amazonaws.com/aws",
    		type: 'POST',
    		crossDomain: true,
    		contentType: 'application/json',
			data: JSON.stringify(cognitoAccess),
			headers:{"Authorization": JSON.stringify(cognitoAccess)},
			dataType: 'json',
			//dataType: "jsonp",
    		success: function(data) {
				console.log(data);
				accessToken = data.accessToken;
   			 },
    		error: function(xhr, ajaxOptions, thrownError) {
				console.log(JSON.stringify(xhr));
   		 }
		});
		
	}
	</script>
</body>
</html>
