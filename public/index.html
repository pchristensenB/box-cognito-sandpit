
<!DOCTYPE html>
<html lang="en-US">
<head>
	<meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
	
<!-- JQuery -->
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>

<script src="/dist/amazon-cognito-auth.js"></script>
	<!-- To enable the advanced security feature -->
	<!-- <script src="https://amazon-cognito-assets.<region>.amazoncognito.com/amazon-cognito-advanced-security-data.min.js"></script> -->
	<!-- E.g. -->
	<!-- <script src="https://amazon-cognito-assets.us-east-1.amazoncognito.com/amazon-cognito-advanced-security-data.min.js"></script> -->
	<title>Box Platform + Cognito</title>

	<!-- CSS -->

	<!-- Font Awesome -->
<link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.8.2/css/all.css">
<!-- Bootstrap core CSS -->
<link href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.3.1/css/bootstrap.min.css" rel="stylesheet">
<!-- Material Design Bootstrap -->
<link href="https://cdnjs.cloudflare.com/ajax/libs/mdbootstrap/4.8.11/css/mdb.min.css" rel="stylesheet">

	<link rel="stylesheet" href="https://cdn01.boxcdn.net/platform/elements/11.0.0/en-US/explorer.css" />
	<style>

	#app-container, #signoutDiv, #loadingDiv
	{
		display: none;
	}
	</style>

<!-- Bootstrap tooltips -->
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.4/umd/popper.min.js"></script>
<!-- Bootstrap core JavaScript -->
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.3.1/js/bootstrap.min.js"></script>
<!-- MDB core JavaScript -->
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mdbootstrap/4.8.11/js/mdb.min.js"></script>
<!-- BOX JS-->

<script src="https://cdn.polyfill.io/v2/polyfill.min.js?features=es6,Intl"></script>

<script src="https://cdn01.boxcdn.net/platform/elements/11.0.0/en-US/explorer.js"></script>

</head>

<body  onload="onLoad()">
	<div class="navbar-wrapper">
		<div class="container">
  
				  <nav class="navbar navbar-expand-lg sticky-top navbar-dark  blue-gradient">
			<div class="container">
			  
			  <div id="navbar" class="navbar-collapse collapse">
					<ul class="navbar-nav mr-auto">
								  <li class="nav-item active"><a class="nav-link waves-effect waves-light" href="#">Home</a></li>
				  <li class="nav-item" id = "loginLink">
						<a class="nav-link waves-effect waves-light" id="signInButton" href="javascript:void(0)" title="Sign in">Log in/Register</a>
  
				</ul>
			  </div>
			</div>
		  </nav>
		</div>
	  </div>
  
	  <div style="margin:auto;width:50%;">
		  		  <div id = "boxUI">
				  <div id = "app-container" style="width:80%;"></div>
			  </div>
		  <section class="view">
			  <div class="row">
				  <div class="col-md-6">
					  <div class="d-flex flex-column  h-100">
						  <h3 class="heading display-4">Welcome to the Cognito and Box Platform Demo</h3>
						  <p class="subheading" id="mainMsg1">Shows Cognito integration with Box platform and app users. In this demo we use 
							  <a href="https://github.com/aws/amazon-cognito-auth-js" target="_new">Cognito's Javascript API</a> and we redirect to 
							  Cognito built-in login and registration forms. The Box App User is created when the user is verified and the 'externa_app_user_id' attribute
							  is populated with the Cognito userID. 
						  </p>
						  <h4 class="subheading" id="mainMsg"></h4>
						  <div>
								<p id="statusNotAuth" title="Status">
									Login or register to continue
								</p>
								<p id="statusAuth" title="Status">
									You have Signed-In
								</p>
							</div>
					  </div>
  
				  </div>
  
				  <div class="col-md-6">
						<a href="#" id="popreg">
								[ Register Diagram |
							</a>
							<a href="#" id="poplog">
								Login Diagram ]
							</a>
					  <div class="view">
						  <img src="https://pchristensenb.github.io/Template/sidebar-image.jpeg" class="img-fluid" alt="smaple image">
						  <div class="mask flex-center gradient">
						  </div>
					  </div>
  
				  </div>
  
			  </div>
  
		  </section>
		</div>
		<div class="modal fade" id="imagemodal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
				<div class="modal-dialog">
					  <div class="modal-content">
						<div class="modal-header">
						  <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
						</div>
						<div class="modal-body" style="background:white;">
						  <img src="" style="margin-left:-400px;margin-top:-100px;" id="imagepreview" >
						</div>
					
					  </div>
				</div>
			</div>
	<script>
function showBoxUI(boxAccessToken) {
	console.log("tok:" + boxAccessToken.accessToken)
	$(".view").hide();
	var folderId = '0';
	var contentExplorer = new Box.ContentExplorer();
	contentExplorer.show(folderId, boxAccessToken.accessToken, {
			container: '#app-container',
			logoUrl: 'box'
	})
	

	$("#app-container").show();
	$("#myModal").toggle();
}
	// Operations when the web page is loaded.
	function onLoad() {
		$("#imagemodal").toggle();

		$("#popreg").on("click", function() {
   			$('#imagepreview').attr('src', '/img/register.png'); 
   			$('#imagemodal').modal('show'); // imagemodal is the id attribute assigned to the bootstrap modal, then i use the show function
		});
		$("#poplog").on("click", function() {
   			$('#imagepreview').attr('src', '/img/login.png'); 
   			$('#imagemodal').modal('show'); // imagemodal is the id attribute assigned to the bootstrap modal, then i use the show function
		});
		var i, items, tabs;
		items = document.getElementsByClassName("tab-pane");
		for (i = 0; i < items.length; i++) {
			items[i].style.display = 'none';
		}
		document.getElementById("statusNotAuth").style.display = 'block';
		document.getElementById("statusAuth").style.display = 'none';
		// Initiatlize CognitoAuth object
		var auth = initCognitoSDK();
		document.getElementById("signInButton").addEventListener("click", function() {
			var state = document.getElementById('signInButton').innerHTML;
			console.log(state=='Log in/Register');
			if(state.contains('Log in/Register')) {
				userButton(auth);
			}
			else {
				auth.signOut();
				//showSignedOut();
			}
		});
		var curUrl = window.location.href;
		auth.parseCognitoWebResponse(curUrl);

	}



  // Perform user operations.
	function userButton(auth) {
		var state = document.getElementById('signInButton').innerHTML;
		if (state === "Sign Out") {
			document.getElementById("signInButton").innerHTML = "Sign In";
			auth.signOut();
			showSignedOut();
		} else {
			auth.getSession();
		}
	}

	// Operations when signed in.
  function showSignedIn(session) {
		document.getElementById("statusNotAuth").style.display = 'none';
		document.getElementById("statusAuth").style.display = 'block';
		document.getElementById("signInButton").innerHTML = "Sign Out";
		if (session) {
			var idToken = session.getIdToken().getJwtToken();
			if (idToken) {
				var payload = idToken.split('.')[1];
				var tokenobj = JSON.parse(atob(payload));
				var formatted = JSON.stringify(tokenobj, undefined, 2);
				document.getElementById('idtoken').innerHTML = formatted;
			}
			var accToken = session.getAccessToken().getJwtToken();
			if (accToken) {
				var payload = accToken.split('.')[1];
				var tokenobj = JSON.parse(atob(payload));
				var formatted = JSON.stringify(tokenobj, undefined, 2);
				//document.getElementById('acctoken').innerHTML = formatted;
			}
			var refToken = session.getRefreshToken().getToken();
			if (refToken) {
				document.getElementById('reftoken').innerHTML = refToken.substring(1, 20);
			}
		}
		//openTab("userdetails");
	}

	// Operations when signed out.
	function showSignedOut() {
		document.getElementById("statusNotAuth").style.display = 'block';
		document.getElementById("statusAuth").style.display = 'none';
		document.getElementById('idtoken').innerHTML = " ... ";
		document.getElementById('acctoken').innerHTML = " ... ";
		document.getElementById('reftoken').innerHTML = " ... ";
		closeTab("userdetails");
	}

  // Initialize a cognito auth object.
	function initCognitoSDK() {
		var authData = {
			ClientId : 'l8ajfjlh0lsrspnknvnqnunpq', // Your client id here
			AppWebDomain : 'boxsandpitdemoapp.auth.eu-west-2.amazoncognito.com', // Exclude the "https://" part. 
			TokenScopesArray : ['email'], // like ['openid','email','phone']...
			RedirectUriSignIn : location.protocol+'//'+location.hostname+(location.port ? ':'+location.port: ''),
			RedirectUriSignOut : location.protocol+'//'+location.hostname+(location.port ? ':'+location.port: ''),
			IdentityProvider : 'box-cognito-sandpit', 
	                UserPoolId : 'eu-west-2_T8FRIx8R8', 
	                AdvancedSecurityDataCollectionFlag : false
		};
		var auth = new AmazonCognitoIdentity.CognitoAuth(authData);
		// You can also set state parameter 
		// auth.setState(<state parameter>);  
		auth.userhandler = {
			onSuccess: function(result) {
				console.log("res:" + JSON.stringify(result));
				showSignedIn(result);
				getBoxToken(result.accessToken);
			},
			onFailure: function(err) {
				alert("Error!" + err);
			}
		};
		return auth;
	}
	function getBoxToken(cognitoAccess) {
		console.log(cognitoAccess);
		$.post( "/boxUI", { accessToken: cognitoAccess.jwtToken }, function(json) {
			console.log("msg: " + JSON.stringify(json.accessToken));
			accessToken = json.accessToken;
			showBoxUI(accessToken)

		})
	}
		
	</script>
</body>
</html>
